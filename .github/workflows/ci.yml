name: CI
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-24.11
          extra_nix_config: |
            experimental-features = nix-command flakes
      - uses: cachix/cachix-action@v15
        with:
          name: unifi-nix
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
        continue-on-error: true
      - name: Check flake
        run: nix flake check --no-build
      - name: Build checks
        run: nix build .#checks.x86_64-linux.formatting .#checks.x86_64-linux.statix .#checks.x86_64-linux.deadnix
      - name: Run all tests
        run: |
          nix build .#checks.x86_64-linux.example-eval
          nix build .#checks.x86_64-linux.module-structure
          nix build .#checks.x86_64-linux.schema-loading
          nix build .#checks.x86_64-linux.schema-validation
          nix build .#checks.x86_64-linux.full-config-eval
          nix build .#checks.x86_64-linux.to-mongo-conversion
          nix build .#checks.x86_64-linux.schema-generated-collections
      - name: Build packages
        run: |
          nix build .#deploy
          nix build .#diff
          nix build .#eval
          nix build .#validate
          nix build .#restore
          nix build .#drift-detect
          nix build .#multi-site
          nix build .#schema-diff
          nix build .#generate-module
          nix build .#generate-schema
          nix build .#extract-schema
          nix build .#unifi
  shellcheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: "./scripts"
          severity: warning
          # Note: Some warnings are acceptable (SC1091 for sourced files, SC2029 for SSH)
          # Run locally with: nix-shell -p shellcheck --run "shellcheck scripts/*.sh"
